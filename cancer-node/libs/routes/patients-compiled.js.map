{"version":3,"sources":["patients.js"],"names":[],"mappings":"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","file":"patients-compiled.js","sourcesContent":["/**\r\n * Created by AsTex on 25.06.2016.\r\n */\r\nvar express = require('express');\r\nvar passport = require('passport');\r\nvar userRouter = express.Router();\r\n\r\nvar treatmentsRouter = express.Router({mergeParams: true});\r\nuserRouter.use('/:userId/treatments', treatmentsRouter);\r\n\r\nvar libs = process.cwd() + '/libs/';\r\nvar log = require(libs + 'log')(module);\r\nvar ObjectId = require('mongoose').Types.ObjectId;\r\n\r\nvar db = require(libs + 'db/mongoose');\r\nvar Patient = require(libs + 'model/patient').Patient;\r\nvar Treatment = require(libs + 'model/treatment');\r\n\r\n\r\nuserRouter.get('/', passport.authenticate('local'), function (req, res) {\r\n    return Patient.find(function (err, patients) {\r\n        if (!err) {\r\n            return res.send({status: 'OK', patients: patients});\r\n        } else {\r\n            res.statusCode = 500;\r\n            log.error('Internal error(%d): %s', res.statusCode, err.message);\r\n            return res.send({error: 'Server error'});\r\n        }\r\n    });\r\n});\r\nuserRouter.post('/', function (req, res) {\r\n    log.error(req.body);\r\n    var patient = new Patient({\r\n        firstName: req.body.firstName,\r\n        lastName: req.body.lastName,\r\n        secondName: req.body.secondName,\r\n        email: req.body.email,\r\n        password: req.body.password,\r\n        phone: req.body.phone,\r\n        location: req.body.location,\r\n        gender: req.body.gender,\r\n        birthDate: req.body.birthDate,\r\n        policyNumber: req.body.policyNumber\r\n    });\r\n\r\n    patient.save(function (err) {\r\n        if (!err) {\r\n            log.info(\"Patient created\");\r\n            return res.send({status: 'OK', patient: patient, apiKey:patient.apiKey, _id:patient._id});\r\n        } else {\r\n            console.log(err);\r\n            if (err.name == 'ValidationError') {\r\n                res.statusCode = 400;\r\n                res.send({error: 'Validation error'});\r\n            } else {\r\n                res.statusCode = 500;\r\n                res.send({error: 'Server Error'});\r\n            }\r\n            log.error('Internal error(%d): %s', res.statusCode, err.message);\r\n        }\r\n\r\n    });\r\n});\r\n//,passport.authenticate(['Header','local']),\r\nuserRouter.get('/:id', passport.authenticate(['header', 'local']), function (req, res) {\r\n    log.debug(req.get('apikey'));\r\n    if (req.authStrategy === 'Header') {\r\n        if (req.params.id !== req.user._id) {\r\n            res.statusCode = 401;\r\n            return res.send({error: 'You can request only your profile'});\r\n        }\r\n    }\r\n    return Patient.findById(req.params.id, function (err, patient) {\r\n        if (!patient) {\r\n            res.statusCode = 404;\r\n            return res.send({error: 'Patient not found'});\r\n        }\r\n        if (!err) {\r\n            return res.send({\r\n                status: 'OK',\r\n                patient: patient\r\n            });\r\n        } else {\r\n            res.statusCode = 500;\r\n            log.error('Internal error(%d): %s', res.statusCode, err.message);\r\n            res.send({\r\n                error: 'Server error'\r\n            });\r\n        }\r\n    })\r\n});\r\n\r\nuserRouter.put('/:id', passport.authenticate('Header'), function (req, res) {\r\n\r\n    return Patient.findById(req.params.id, function (err, patient) {\r\n        if (!patient) {\r\n            res.statusCode = 404;\r\n            return res.send({error: 'Patient not found'});\r\n        }\r\n        patient.firstName = req.body.firstName;\r\n        patient.lastName = req.body.lastName;\r\n        patient.secondName = req.body.secondName;\r\n        patient.location = req.body.location;\r\n        patient.policyNumber = req.body.policyNumber;\r\n        return patient.save(function (err) {\r\n            if (!err) {\r\n                log.info('Patient updated');\r\n                return res.send({status: 'OK', patient: patient});\r\n            } else {\r\n                if (err.name == 'ValidationError') {\r\n                    res.statusCode = 400;\r\n                    res.send({error: 'Validation Error'});\r\n                } else {\r\n                    res.statusCode = 500;\r\n                    res.send({error: 'Server error'});\r\n                }\r\n                log.error('Internal error(%d): %s', res.statusCode, err.message);\r\n            }\r\n        });\r\n    })\r\n});\r\nuserRouter.delete('/:id', function(res,req){\r\n    return PatientModel.findById(req.params.id, function(err,patient){\r\n        if(!patient){\r\n            res.statusCode = 404;\r\n            return res.send({error:'Patient not found'});\r\n        }\r\n        return patient.remove(function (err) {\r\n            if(!err){\r\n                log.info('Patient removed');\r\n                return res.send({status:'OK'});\r\n            } else{\r\n                res.statusCode = 500;\r\n                log.error('Internal error(%d): %s', res.statusCode, err.message);\r\n                return res.send({error:'Server Error'});\r\n            }\r\n        })\r\n    });\r\n});\r\n\r\ntreatmentsRouter.get('/', passport.authenticate(['header', 'local']), function (req, res) {\r\n        if (req.authStrategy === 'Header') {\r\n            log.error(req.user._id + ' ' + req.params.userId);\r\n            if (req.params.userId != req.user._id) {\r\n                res.statusCode = 401;\r\n                return res.send({error: 'You can request only your profile'});\r\n            } else {\r\n\r\n                Treatment.find({'author': req.user._id}, function (err, treatments) {\r\n                    if (!err) {\r\n                        return res.send({status: 'OK', treatments: treatments});\r\n                    } else {\r\n                        res.statusCode = 500;\r\n                        log.error('Internal error(%d): %s', res.statusCode, err.message);\r\n                        res.send({\r\n                            error: 'Server error'\r\n                        });\r\n                    }\r\n\r\n                })\r\n\r\n            }\r\n        }\r\n    });\r\n\r\ntreatmentsRouter.get('/:treatmentId', passport.authenticate(['header', 'local']), function (req, res) {\r\n    if (req.authStrategy === 'Header') {\r\n        if (req.params.userId != req.user._id) {\r\n            res.statusCode = 401;\r\n            return res.send({error: 'You can request only your profile'});\r\n        }\r\n     else {\r\n        Treatment.find({'author': req.params.userId, '_id': req.params.treatmentId}, function (err, treatment) {\r\n            if (!err) {\r\n                return res.send({status: 'OK', treatment: treatment});\r\n            } else {\r\n                res.statusCode = 500;\r\n                log.error('Internal error(%d): %s', res.statusCode, err.message);\r\n                res.send({\r\n                    error: 'Server error'\r\n                });\r\n            }\r\n        })\r\n    }}\r\n});\r\n\r\nmodule.exports = userRouter;"]}