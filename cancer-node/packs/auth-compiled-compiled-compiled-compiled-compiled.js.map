{"version":3,"sources":["auth-compiled-compiled-compiled-compiled.js"],"names":[],"mappings":"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","file":"auth-compiled-compiled-compiled-compiled-compiled.js","sourcesContent":["'use strict';\n\n/**\r\n * Created by AsTex on 25.06.2016.\r\n */\n\nvar passport = require('passport');\nvar BasicStrategy = require('passport-http').BasicStrategy;\nvar LocalStrategy = require('passport-local').Strategy;\nvar HeaderStrategy = require('passportjs-header').Strategy;\nvar headerStrategy = require('passport-http-header-strategy').Strategy;\nvar CustomStrategy = require('passport-custom').Strategy;\nvar log = require('../log')(module);\nvar libs = process.cwd() + '/libs/';\n\nvar config = require(libs + 'config');\n\nvar Doctor = require(libs + 'model/doctor');\nvar Patient = require(libs + 'model/patient').Patient;\n\n/*passport.use('header-own', new CustomStrategy(\r\n function(req, done) {\r\n Patient.findOne({apiKey:api}, function(err,patient){\r\n if (err) { return done(err); }\r\n if(!patient) return done(null, false, { error: 'Invalid token.' });\r\n if(!patient.checkApiKey(api)) {\r\n return done(null, false, {error: 'Incorrect token.'});\r\n }\r\n req.authStrategy = 'Header';\r\n return done(null,patient);\r\n });\r\n }\r\n ));\r\n */\n\npassport.serializeUser(function (user, done) {\n    done(null, user);\n});\n\npassport.deserializeUser(function (user, done) {\n    done(null, user);\n});\n\npassport.use(new headerStrategy({ header: 'X-API-KEY', passReqToCallback: true }, function (req, token, done) {\n    Patient.findOne({ apiKey: token }, function (err, patient) {\n        if (err) {\n            return done(err);\n        }\n\n        if (!patient) return done(null, false, { error: 'Invalid token.' });\n        if (!patient.checkApiKey(token)) {\n            return done(null, false, { error: 'Incorrect token.' });\n        }\n        req.authStrategy = 'Header';\n        return done(null, patient);\n    });\n}));\n/*\r\n passport.use('test', new CustomStrategy({passReqToCallback: true},\r\n function (req, done) {\r\n this._verify = done;\r\n log.debug('test');\r\n console.log(req.body.email);\r\n console.log(req.body.password);\r\n if (!req.cookies.session) {\r\n if (!req.body.email || !req.body.password) {\r\n return done(null, false, {error: 'Incorrect credentials.'});\r\n }\r\n else {\r\n Doctor.findOne({email: req.body.email}, function (err, doctor) {\r\n log.debug('test');\r\n if (err) {\r\n return done(err, false, {error: 'Incorrect username.'});\r\n }\r\n if (!doctor) {\r\n return done(null, false, {error: 'Incorrect username.'});\r\n }\r\n if (!doctor.checkPassword(req.body.password)) {\r\n return done(null, false, {error: 'Incorrect password.'});\r\n }\r\n req.authStrategy = 'Local';\r\n res.cookie('session', doctor.sessionId);\r\n return done(null, doctor);\r\n });\r\n }\r\n } else {\r\n Doctor.findOne({sessionId: req.cookies.session}, function (err, doctor) {\r\n if (err) {\r\n return done(err, false, {error: 'Incorrect username.'});\r\n }\r\n if (!doctor) {\r\n return done(null, false, {error: 'Incorrect username.'});\r\n }\r\n return done(null, doctor);\r\n });\r\n\r\n }\r\n log.debug('test');\r\n }));\r\n\r\n */\n\npassport.use(new LocalStrategy({ usernameField: 'email', passwordField: 'password', passReqToCallback: true }, function (req, username, password, done) {\n    console.log(req.body.email);\n    console.log(req.body.password);\n    if (!req.cookies.session) {\n        if (!req.body.email || !req.body.password) {\n            return done(null, false, { error: 'Incorrect credentials.' });\n        } else {\n            Doctor.findOne({ email: username }, function (err, doctor) {\n                log.debug('test');\n                if (err) {\n                    return done(err, false, { error: 'Incorrect username.' });\n                }\n                if (!doctor) {\n                    return done(null, false, { error: 'Incorrect username.' });\n                }\n                if (!doctor.checkPassword(req.body.password)) {\n                    return done(null, false, { error: 'Incorrect password.' });\n                }\n                req.authStrategy = 'Local';\n                return done(null, doctor);\n            });\n        }\n    } else {\n        Doctor.findOne({ sessionId: req.cookies.session }, function (err, doctor) {\n            if (err) {\n                return done(err, false, { error: 'Incorrect username.' });\n            }\n            if (!doctor) {\n                return done(null, false, { error: 'Incorrect username.' });\n            }\n            return done(null, doctor);\n        });\n    }\n    log.debug('test');\n}));\n\npassport.use(new BasicStrategy(function (email, password, done) {\n    Patient.findOne({ email: email }, function (err, patient) {\n        if (err) {\n            log.debug('Bad request');\n            return done(err);\n        }\n        if (!patient) {\n            log.debug('Bad request2');\n            return done(null, false, { error: \"No authentication data provided\" });\n        }\n        if (!patient.checkPassword(password)) {\n            return done(null, false);\n        }\n        return done(null, patient);\n    });\n}));\n\n//# sourceMappingURL=auth-compiled.js.map\n\n//# sourceMappingURL=auth-compiled-compiled.js.map\n\n//# sourceMappingURL=auth-compiled-compiled-compiled.js.map\n\n//# sourceMappingURL=auth-compiled-compiled-compiled-compiled.js.map"]}